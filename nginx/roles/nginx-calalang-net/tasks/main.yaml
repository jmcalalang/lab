# NGINX Application Services

# Create NGINX Resources through {{ NMShost01 }}

- name: Verify NGINX Instance Manager {{ NMShost01 }} is Available
  delegate_to: localhost
  uri:
    headers:
      token: "{{ NMSadminToken }}"
    force_basic_auth: yes
    url_password: "{{ NMSadminPassword }}"
    url_username: "{{ NMSadminUsername }}"
    method: GET
    url: "https://{{ nmss }}/api/platform/v1/instances"
    status_code: "200"
    validate_certs: yes
  register: nginx_auth_response
  retries: 30
  delay: 5
#  until: "(nginx_auth_response is successful) and (nginx_auth_response.status == 200)"
  when: state == "present"
  with_items:
    - "{{ nmss }}"

- name: Debug nginx_auth_response
  ansible.builtin.debug:
    var: "{{ nginx_auth_response }}"
    verbosity: 4

# - name: Prepare the Common AS3 Declaration
#   template: src="../../f5-automation-toolchain/as3/bigip-common.template" dest="../../f5-automation-toolchain/as3/bigip-common.json"
#   delegate_to: localhost
#   when: state == "present"
# 
# - name: Create or update {{BIGIPhost01}}; Common AS3 Declaration
#   delegate_to: localhost
#   uri:
#     body: "{{ lookup('file','../../f5-automation-toolchain/as3/' + 'bigip-common.json') }}"
#     body_format: json
#     headers:
#       X-F5-Auth-Token: "{{ bigip1_auth_token }}"
#     method: POST
#     status_code: [200, 202]
#     url: "https://{{BIGIPhost01}}/mgmt/shared/appsvcs/declare"
#     validate_certs: no
#     timeout: "60"
#   register: result
#   retries: 30
#   delay: 5
#   until: "(result.status == 200) or (result.status == 202)"
#   when: state == "present"